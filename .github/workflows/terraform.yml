terraform output -json > tf_output.json

echo "Terraform Output JSON:"
cat tf_output.json

# Validate JSON
if jq empty tf_output.json 2>/dev/null; then
    echo "✅ JSON is valid."
else
    echo "❌ Invalid JSON detected. Terraform output might be empty or incorrect."
    exit 1
fi

# Extract values safely
PUBLIC_IP=$(jq -r '.public_ip.value // empty' tf_output.json)
INSTANCE_TYPE=$(jq -r '.instance_type.value // empty' tf_output.json)

# Default values if missing
PUBLIC_IP=${PUBLIC_IP:-"No Public IP"}
INSTANCE_TYPE=${INSTANCE_TYPE:-"Unknown Instance Type"}

echo "PUBLIC_IP=$PUBLIC_IP" >> $GITHUB_ENV
echo "INSTANCE_TYPE=$INSTANCE_TYPE" >> $GITHUB_ENV

echo "✅ Extracted Details:"
echo "📌 PUBLIC_IP: $PUBLIC_IP"
echo "📌 INSTANCE_TYPE: $INSTANCE_TYPE"
